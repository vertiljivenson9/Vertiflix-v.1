<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VERTIFLIX - Streaming Premium</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --netflix-red: #e50914;
            --netflix-black: #141414;
            --netflix-dark: #181818;
            --netflix-gray: #808080;
            --netflix-white: #ffffff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: var(--netflix-black);
            color: var(--netflix-white);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* üî• MODAL DE VIDEO EMbebido solo para Drive üî• */
        .video-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 2001;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .video-container {
            width: 90%;
            height: 80%;
            position: relative;
            max-width: 1200px;
        }

        .video-iframe {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 8px;
        }

        .close-video-btn {
            position: absolute;
            top: -50px;
            right: 0;
            background: var(--netflix-red);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        /* Header */
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 50px;
            background: var(--netflix-black);
            position: sticky;
            top: 0;
            width: 100%;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        .logo {
            color: var(--netflix-red);
            font-size: 2rem;
            font-weight: bold;
            text-decoration: none;
        }

        .search-container {
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
        }

        .search-input {
            padding: 10px 15px;
            border: none;
            border-radius: 20px;
            background: rgba(255,255,255,0.1);
            color: white;
            width: 250px;
            transition: all 0.3s;
        }

        .search-input:focus {
            outline: none;
            background: rgba(255,255,255,0.2);
            width: 300px;
        }

        .search-btn {
            background: var(--netflix-red);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            width: 40px;
            height: 40px;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            width: 300px;
            background: var(--netflix-dark);
            border-radius: 8px;
            margin-top: 10px;
            max-height: 400px;
            overflow-y: auto;
            display: none;
            z-index: 1001;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        .search-result-item {
            padding: 12px 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid #2a2a2a;
        }

        .search-result-item:hover {
            background: #2a2a2a;
        }

        .search-result-item img {
            width: 50px;
            height: 70px;
            object-fit: cover;
            border-radius: 4px;
        }

        /* Categor√≠as */
        .categories-bar {
            display: flex;
            gap: 25px;
            padding: 20px 50px;
            background: var(--netflix-dark);
            overflow-x: auto;
            white-space: nowrap;
            scrollbar-width: none;
        }

        .categories-bar::-webkit-scrollbar {
            display: none;
        }

        .category-btn {
            background: transparent;
            color: var(--netflix-white);
            border: 1px solid var(--netflix-gray);
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .category-btn:hover,
        .category-btn.active {
            background: var(--netflix-red);
            border-color: var(--netflix-red);
            color: white;
        }

        /* Hero */
        .hero {
            height: 60vh;
            background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.4)), 
                       url('https://images.unsplash.com/photo-1489599102910-59206b8ca314?w=1200&q=80');
            background-size: cover;
            background-position: center;
            display: flex;
            align-items: center;
            padding: 0 50px;
        }

        .hero-content {
            max-width: 600px;
        }

        .hero-title {
            font-size: 3rem;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .hero-description {
            font-size: 1.2rem;
            margin-bottom: 30px;
            color: #ccc;
        }

        .hero-buttons {
            display: flex;
            gap: 15px;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--netflix-red);
            color: white;
        }

        .btn-secondary {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .btn:hover {
            transform: scale(1.05);
        }

        /* üî• GRID DE PEL√çCULAS TAMA√ëO OPTIMIZADO üî• */
        .movies-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            padding: 40px 50px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .movie-card {
            background: var(--netflix-dark);
            border-radius: 10px;
            overflow: hidden;
            transition: transform 0.3s;
            cursor: pointer;
            aspect-ratio: 2/3;
            position: relative;
        }

        .movie-card:hover {
            transform: scale(1.05);
        }

        .movie-poster {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .movie-info {
            padding: 15px;
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            transform: translateY(100%);
            transition: transform 0.3s;
        }

        .movie-card:hover .movie-info {
            transform: translateY(0);
        }

        .movie-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 5px;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .movie-details {
            color: #888;
            font-size: 12px;
        }

        /* Modal de pel√≠cula */
        .movie-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .movie-modal-content {
            background: #1a1a1a;
            border-radius: 15px;
            max-width: 900px;
            width: 100%;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
            position: relative;
        }

        .movie-modal-poster {
            width: 100%;
            height: 500px;
            object-fit: cover;
            border-radius: 10px;
        }

        .movie-modal-info {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .movie-modal-title {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: white;
        }

        .movie-modal-details {
            color: #888;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .movie-modal-description {
            color: #ccc;
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 25px;
        }

        .movie-modal-buttons {
            display: flex;
            gap: 15px;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #666;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
        }

        /* üî• TABLA ADMIN MEJORADA üî• */
        .movies-table {
            width: 100%;
            background: #2a2a2a;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .movies-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .movies-table th,
        .movies-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #444;
        }

        .movies-table th {
            background: var(--netflix-red);
            color: white;
            position: sticky;
            top: 0;
        }

        .movies-table tr:hover {
            background: #3a3a3a;
        }

        .btn-delete {
            background: #e50914;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-delete:hover {
            background: #c40812;
        }

        /* Donaciones sticky footer */
        .donation-footer {
            position: sticky;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            text-align: center;
            margin-top: 40px;
            z-index: 500;
        }

        .donation-text {
            color: rgba(255,255,255,0.9);
            margin-bottom: 10px;
            font-size: 1rem;
        }

        /* Panel de administraci√≥n */
        .admin-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 2003;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow-y: auto;
        }

        .admin-container {
            background: #1a1a1a;
            padding: 30px;
            border-radius: 15px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .admin-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid #333;
            padding-bottom: 15px;
            flex-wrap: wrap;
        }

        .admin-tab {
            background: #2a2a2a;
            color: #ccc;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .admin-tab.active {
            background: var(--netflix-red);
            color: white;
        }

        .admin-tab-content {
            display: none;
        }

        .admin-tab-content.active {
            display: block;
        }

        .admin-form {
            display: grid;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group label {
            font-weight: bold;
            color: #ccc;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px;
            border: 1px solid #333;
            border-radius: 5px;
            background: #2a2a2a;
            color: white;
            font-size: 16px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .movies-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                padding: 20px;
                gap: 15px;
            }

            .navbar {
                padding: 15px 20px;
                flex-wrap: wrap;
                gap: 15px;
            }

            .categories-bar {
                padding: 15px 20px;
            }

            .hero {
                height: 50vh;
                padding: 0 20px;
            }

            .hero-title {
                font-size: 2rem;
            }

            .movie-modal-content {
                grid-template-columns: 1fr;
                text-align: center;
            }

            .movie-modal-poster {
                height: 300px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .movies-table {
                font-size: 14px;
            }

            .movies-table th,
            .movies-table td {
                padding: 8px;
            }
        }

        @media (max-width: 480px) {
            .movies-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                padding: 15px;
            }

            .movie-card {
                aspect-ratio: 2/3;
            }

            .movie-title {
                font-size: 12px;
            }

            .movie-details {
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <a href="#" class="logo">VERTIFLIX</a>
        
        <div class="search-container">
            <input type="text" id="search-input" class="search-input" placeholder="Buscar pel√≠culas...">
            <button class="search-btn" onclick="searchMovies()">
                <i class="fas fa-search"></i>
            </button>
            <div class="search-results" id="search-results"></div>
        </div>
        
        <button class="btn btn-primary" onclick="showAdminPanel()">
            <i class="fas fa-cog"></i> Admin
        </button>
    </nav>

    <!-- Hero Section -->
    <section class="hero">
        <div class="hero-content">
            <h1 class="hero-title">Disfruta donde quieras, cancela cuando quieras</h1>
            <p class="hero-description">Millones de pel√≠culas y series. Sin l√≠mites. Sin anuncios.</p>
            <div class="hero-buttons">
                <button class="btn btn-primary" onclick="scrollToMovies()">Ver Pel√≠culas</button>
                <button class="btn btn-secondary" onclick="showInfo()">M√°s informaci√≥n</button>
            </div>
        </div>
    </section>

    <!-- Categor√≠as -->
    <div class="categories-bar" id="categories">
        <button class="category-btn active" onclick="filterByCategory('todas')">Todas</button>
        <button class="category-btn" onclick="filterByCategory('accion')">Acci√≥n</button>
        <button class="category-btn" onclick="filterByCategory('drama')">Drama</button>
        <button class="category-btn" onclick="filterByCategory('comedia')">Comedia</button>
        <button class="category-btn" onclick="filterByCategory('ciencia ficcion')">Ciencia Ficci√≥n</button>
        <button class="category-btn" onclick="filterByCategory('terror')">Terror</button>
    </div>

    <!-- Grid de Pel√≠culas -->
    <div class="movies-grid" id="movies-grid">
        <div class="loading">Cargando pel√≠culas...</div>
    </div>

    <!-- Modal de informaci√≥n de pel√≠cula -->
    <div id="movie-modal" class="movie-modal">
        <div class="movie-modal-content">
            <button class="modal-close" onclick="closeMovieModal()">‚úñ</button>
            <img id="modal-poster" class="movie-modal-poster" src="" alt="">
            <div class="movie-modal-info">
                <h2 id="modal-title" class="movie-modal-title"></h2>
                <div id="modal-details" class="movie-modal-details"></div>
                <p id="modal-description" class="movie-modal-description"></p>
                <div class="movie-modal-buttons">
                    <button id="modal-play-btn" class="btn btn-primary" onclick="playCurrentMovie()">
                        ‚ñ∂ Reproducir
                    </button>
                    <button class="btn btn-secondary" onclick="closeMovieModal()">
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- üî• MODAL DE VIDEO EMbebido solo para Drive üî• -->
    <div id="video-modal" class="video-modal">
        <div class="video-container">
            <iframe id="video-iframe" class="video-iframe" allowfullscreen></iframe>
            <button class="close-video-btn" onclick="closeVideoModal()">‚úñ Cerrar Video</button>
        </div>
    </div>

    <!-- Donaciones Sticky Footer -->
    <div class="donation-footer">
        <p class="donation-text">¬øTe gusta VertiFlix? Apoya el proyecto para mantenerlo gratis para todos</p>
        <button class="btn btn-primary" onclick="openDonation()">‚ù§Ô∏è Donar Ahora</button>
    </div>

    <!-- Panel de administraci√≥n -->
    <div id="admin-modal" class="admin-modal">
        <div class="admin-container">
            <h2 style="color: #e50914; margin-bottom: 20px; text-align: center;">‚öôÔ∏è Panel de Administraci√≥n</h2>
            
            <div class="admin-tabs">
                <button class="admin-tab active" onclick="switchAdminTab('peliculas')">üé¨ Pel√≠culas</button>
                <button class="admin-tab" onclick="switchAdminTab('config')">‚öôÔ∏è Configuraci√≥n</button>
                <button class="admin-tab" onclick="switchAdminTab('donaciones')">üí∞ Donaciones</button>
            </div>
            
            <!-- Pesta√±a Pel√≠culas con Cloudinary -->
            <div id="tab-peliculas" class="admin-tab-content active">
                <form id="admin-form" class="admin-form" onsubmit="addNewMovie(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>T√≠tulo:</label>
                            <input type="text" id="admin-title" required>
                        </div>
                        <div class="form-group">
                            <label>A√±o:</label>
                            <input type="number" id="admin-year" required min="1900" max="2030">
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>G√©nero:</label>
                            <select id="admin-genre" required>
                                <option value="Acci√≥n">Acci√≥n</option>
                                <option value="Drama">Drama</option>
                                <option value="Comedia">Comedia</option>
                                <option value="Ciencia Ficci√≥n">Ciencia Ficci√≥n</option>
                                <option value="Terror">Terror</option>
                                <option value="Aventura">Aventura</option>
                                <option value="Romance">Romance</option>
                                <option value="Animaci√≥n">Animaci√≥n</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Duraci√≥n (min):</label>
                            <input type="number" id="admin-duration" required min="1" max="500">
                        </div>
                    </div>
                    
                    <!-- üî• CLOUDINARY FILE UPLOAD üî• -->
                    <div class="form-group">
                        <label>Imagen (subir desde PC):</label>
                        <input type="file" id="admin-image-file" accept="image/*" required>
                        <div id="upload-progress" style="margin-top: 10px; color: #ccc; display: none;">
                            Subiendo imagen... <span id="progress-percent">0%</span>
                        </div>
                        <input type="hidden" id="admin-image" required>
                    </div>
                    
                    <div class="form-group">
                        <label>URL del Video (Drive/Terabox):</label>
                        <input type="url" id="admin-video" required placeholder="https://drive.google.com/...">
                    </div>
                    
                    <div class="form-group">
                        <label>Descripci√≥n:</label>
                        <textarea id="admin-description" required></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Guardar Pel√≠cula
                    </button>
                </form>

                <!-- üî• TABLA DE PEL√çCULAS CON ELIMINAR üî• -->
                <div class="movies-table" id="movies-table">
                    <h3 style="color: #e50914; margin: 20px 0;">üìã Pel√≠culas Existentes</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Poster</th>
                                <th>T√≠tulo</th>
                                <th>G√©nero</th>
                                <th>A√±o</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="movies-table-body">
                            <tr><td colspan="5" style="text-align: center;">Cargando pel√≠culas...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Pesta√±a Configuraci√≥n -->
            <div id="tab-config" class="admin-tab-content">
                <div class="admin-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Anuncios:</label>
                            <select id="admin-ads">
                                <option value="true">Activados</option>
                                <option value="false" selected>Desactivados</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Duraci√≥n (seg):</label>
                            <input type="number" id="ad-duration" value="5" min="3" max="10">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="saveConfigSettings()">
                        <i class="fas fa-save"></i> Guardar Configuraci√≥n
                    </button>
                </div>
            </div>
            
            <!-- Pesta√±a Donaciones -->
            <div id="tab-donaciones" class="admin-tab-content">
                <div class="admin-form">
                    <div class="form-group">
                        <label>URL de PayPal para Donaciones:</label>
                        <input type="url" id="admin-paypal" placeholder="https://paypal.me/tuusuario">
                    </div>
                    <button class="btn btn-primary" onclick="saveDonationSettings()">
                        <i class="fas fa-save"></i> Guardar URL de PayPal
                    </button>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 25px;">
                <button class="btn btn-secondary" onclick="closeAdminModal()">
                    <i class="fas fa-times"></i> Cerrar Panel
                </button>
            </div>
        </div>
    </div>

    <script>
        // üîß CONFIGURACI√ìN
        const SUPABASE_URL = 'https://lvtztvlojdfsnvdytdmk.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx2dHp0dmxvamRmc252ZHl0ZG1rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5NDY2NTIsImV4cCI6MjA3MzUyMjY1Mn0.1Q-yzhJMU2dsQGfPfnJpzGLqIspVUFFjMj9TBu1-BkM';
        const CLOUDINARY_CLOUD_NAME = 'dcclzhsim';
        const CLOUDINARY_UPLOAD_PRESET = 'vertiflix_thumbnails';

        // Variables globales
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let allMovies = [];
        let currentMovie = null;
        let config = {
            paypalUrl: '',
            adEnabled: false,
            adDuration: 5
        };

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', async () => {
            loadConfig();
            initSearch();
            initCloudinaryUpload();
            await loadAllContent();
            await loadMoviesTable();
        });

        // Configuraci√≥n
        function loadConfig() {
            const savedConfig = localStorage.getItem('vertiflix_config');
            if (savedConfig) {
                config = JSON.parse(savedConfig);
            }
        }

        function saveConfig() {
            localStorage.setItem('vertiflix_config', JSON.stringify(config));
        }

        // üî• CLOUDINARY UPLOAD üî•
        function initCloudinaryUpload() {
            const fileInput = document.getElementById('admin-image-file');
            fileInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const progressDiv = document.getElementById('upload-progress');
                const progressPercent = document.getElementById('progress-percent');
                
                progressDiv.style.display = 'block';

                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

                try {
                    const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();
                    
                    if (data.secure_url) {
                        document.getElementById('admin-image').value = data.secure_url;
                        progressDiv.innerHTML = '‚úÖ Imagen subida correctamente';
                        setTimeout(() => {
                            progressDiv.style.display = 'none';
                        }, 2000);
                    }
                } catch (error) {
                    progressDiv.innerHTML = '‚ùå Error al subir imagen';
                }
            });
        }

        // üî• CARGAR TABLA DE PEL√çCULAS COMPLETA üî•
        async function loadMoviesTable() {
            try {
                const { data: movies, error } = await supabase
                    .from('Pel√≠cula')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                const tbody = document.getElementById('movies-table-body');
                
                if (!movies || movies.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No hay pel√≠culas registradas</td></tr>';
                    return;
                }
                
                tbody.innerHTML = movies.map(movie => `
                    <tr>
                        <td><img src="${movie.url_imagen}" alt="${movie.titulo}" style="width: 50px; height: 70px; object-fit: cover; border-radius: 4px;" onerror="this.src='https://images.unsplash.com/photo-1485846234645-a62644f84728?w=50&h=70&q=80'"></td>
                        <td><strong>${movie.titulo}</strong><br><small style="color: #888;">${movie.duracion} min</small></td>
                        <td>${movie.genero}</td>
                        <td>${movie.anio}</td>
                        <td>
                            <button class="btn-delete" onclick="deleteMovie(${movie.id}, '${movie.titulo}')">
                                <i class="fas fa-trash"></i> Eliminar
                            </button>
                        </td>
                    </tr>
                `).join('');
                
            } catch (error) {
                document.getElementById('movies-table-body').innerHTML = '<tr><td colspan="5" style="text-align: center;">Error al cargar pel√≠culas</td></tr>';
            }
        }

        // üî• ELIMINAR PEL√çCULA üî•
        async function deleteMovie(movieId, movieTitle) {
            if (!confirm(`¬øEst√°s seguro de eliminar la pel√≠cula "${movieTitle}"?`)) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('Pel√≠cula')
                    .delete()
                    .eq('id', movieId);
                
                if (error) throw error;
                
                alert('‚úÖ Pel√≠cula eliminada correctamente');
                await loadAllContent();
                await loadMoviesTable();
                
            } catch (error) {
                alert('‚ùå Error al eliminar la pel√≠cula');
            }
        }

        // B√∫squeda
        function initSearch() {
            const searchInput = document.getElementById('search-input');
            const searchResults = document.getElementById('search-results');
            const searchContainer = document.querySelector('.search-container');
            
            searchInput.addEventListener('input', () => {
                const searchTerm = searchInput.value.trim();
                
                if (searchTerm.length === 0) {
                    searchResults.style.display = 'none';
                    return;
                }
                
                const filteredMovies = allMovies.filter(movie => 
                    movie.titulo.toLowerCase().startsWith(searchTerm.toLowerCase())
                );
                
                displaySearchResults(filteredMovies);
            });
            
            document.addEventListener('click', (e) => {
                if (!searchContainer.contains(e.target)) {
                    searchResults.style.display = 'none';
                }
            });
        }

        function displaySearchResults(movies) {
            const searchResults = document.getElementById('search-results');
            
            if (movies.length === 0) {
                searchResults.innerHTML = '<div class="search-result-item">No se encontraron resultados</div>';
                searchResults.style.display = 'block';
                return;
            }
            
            searchResults.innerHTML = movies.map(movie => `
                <div class="search-result-item" onclick="selectSearchResult(${movie.id})">
                    <img src="${movie.url_imagen}" alt="${movie.titulo}" 
                         onerror="this.src='https://images.unsplash.com/photo-1485846234645-a62644f84728?w=50&h=70&q=80'">
                    <div class="search-result-info">
                        <div class="search-result-title">${movie.titulo}</div>
                        <div class="search-result-year">${movie.anio} ‚Ä¢ ${movie.genero}</div>
                    </div>
                </div>
            `).join('');
            
            searchResults.style.display = 'block';
        }

        function selectSearchResult(movieId) {
            const movie = allMovies.find(m => m.id === movieId);
            if (movie) {
                showMovieInfo(movie);
                document.getElementById('search-results').style.display = 'none';
                document.getElementById('search-input').value = '';
            }
        }

        // üî• CARGAR PEL√çCULAS SIN AGRUPAR üî•
        async function loadAllContent() {
            try {
                const { data: movies, error } = await supabase
                    .from('Pel√≠cula')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                allMovies = movies || [];
                displayMovies(allMovies); // Mostrar TODO sin agrupar
                
            } catch (error) {
                document.getElementById('movies-grid').innerHTML = '<div class="loading">Error al cargar pel√≠culas</div>';
            }
        }

        // üî• ANTI-DUPLICADOS AL SUBIR üî•
        async function addNewMovie(event) {
            event.preventDefault();
            
            const imageUrl = document.getElementById('admin-image').value;
            if (!imageUrl) {
                alert('‚ùå Por favor sube una imagen primero');
                return;
            }
            
            const titulo = document.getElementById('admin-title').value.trim();
            const urlVideo = document.getElementById('admin-video').value.trim();
            
            // Verificar duplicados
            try {
                const { data: existingMovies } = await supabase
                    .from('Pel√≠cula')
                    .select('titulo, url_video');
                
                const duplicate = existingMovies?.find(movie => 
                    movie.titulo.toLowerCase() === titulo.toLowerCase() || 
                    movie.url_video === urlVideo
                );
                
                if (duplicate) {
                    alert('‚ùå Ya existe una pel√≠cula con ese t√≠tulo o URL de video');
                    return;
                }
                
            } catch (error) {
                console.error('Error verificando duplicados:', error);
            }
            
            const formData = {
                titulo: titulo,
                anio: parseInt(document.getElementById('admin-year').value),
                genero: document.getElementById('admin-genre').value,
                duracion: parseInt(document.getElementById('admin-duration').value),
                url_imagen: imageUrl,
                url_video: urlVideo,
                descripcion: document.getElementById('admin-description').value
            };
            
            try {
                const { data, error } = await supabase
                    .from('Pel√≠cula')
                    .insert([formData]);
                
                if (error) throw error;
                
                alert('‚úÖ Pel√≠cula agregada correctamente!');
                document.getElementById('admin-form').reset();
                await loadAllContent();
                await loadMoviesTable();
                closeAdminModal();
                
            } catch (error) {
                console.error('Error agregando pel√≠cula:', error);
                alert('‚ùå Error al agregar la pel√≠cula');
            }
        }

        // Mostrar pel√≠culas en grid (sin agrupar)
        function displayMovies(movies) {
            const container = document.getElementById('movies-grid');
            
            if (!movies || movies.length === 0) {
                container.innerHTML = '<div class="loading">No hay pel√≠culas disponibles</div>';
                return;
            }
            
            container.innerHTML = movies.map(movie => `
                <div class="movie-card" onclick="showMovieInfo(${movie.id})">
                    <img src="${movie.url_imagen}" alt="${movie.titulo}" class="movie-poster"
                         onerror="this.src='https://images.unsplash.com/photo-1485846234645-a62644f84728?w=400&q=80'">
                    <div class="movie-info">
                        <div class="movie-title">${movie.titulo}</div>
                        <div class="movie-details">${movie.anio} ‚Ä¢ ${movie.genero}</div>
                    </div>
                </div>
            `).join('');
        }

        // üî• FILTRAR POR CATEGOR√çA SIN DUPLICAR üî•
        function filterByCategory(category) {
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            let filteredMovies = allMovies;
            if (category !== 'todas') {
                filteredMovies = allMovies.filter(movie => 
                    movie.genero && movie.genero.toLowerCase() === category.toLowerCase()
                );
            }
            
            displayMovies(filteredMovies); // Mostrar filtrado sin duplicar
        }

        function showMovieInfo(movieId) {
            const movie = allMovies.find(m => m.id === movieId);
            if (!movie) return;
            
            currentMovie = movie;
            
            const modal = document.getElementById('movie-modal');
            const poster = document.getElementById('modal-poster');
            const title = document.getElementById('modal-title');
            const details = document.getElementById('modal-details');
            const description = document.getElementById('modal-description');
            
            poster.src = movie.url_imagen;
            poster.onerror = () => {
                poster.src = 'https://images.unsplash.com/photo-1485846234645-a62644f84728?w=400&q=80';
            };
            
            title.textContent = movie.titulo;
            details.textContent = `${movie.anio} ‚Ä¢ ${movie.genero} ‚Ä¢ ${movie.duracion} min`;
            description.textContent = movie.descripcion || 'No hay descripci√≥n disponible.';
            
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeMovieModal() {
            const modal = document.getElementById('movie-modal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
            currentMovie = null;
        }

        // üî• L√ìGICA CORREGIDA: EMbebido solo para Drive üî•
        function playCurrentMovie() {
            if (!currentMovie) return;
            
            const videoUrl = currentMovie.url_video;
            
            // Si es Google Drive -> embebido
            if (videoUrl.includes('drive.google.com')) {
                let embedUrl = videoUrl;
                const match = videoUrl.match(/\/d\/([^\/]+)/);
                if (match) {
                    embedUrl = `https://drive.google.com/file/d/${match[1]}/preview`;
                }
                
                const videoModal = document.getElementById('video-modal');
                const videoIframe = document.getElementById('video-iframe');
                
                videoIframe.src = embedUrl;
                videoModal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
            // Si es Terabox u otro -> redirecci√≥n normal
            else {
                window.open(videoUrl, '_blank');
                closeMovieModal();
            }
        }

        function closeVideoModal() {
            const videoModal = document.getElementById('video-modal');
            const videoIframe = document.getElementById('video-iframe');
            
            videoIframe.src = '';
            videoModal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function openDonation() {
            if (config.paypalUrl) {
                window.open(config.paypalUrl, '_blank');
            } else {
                alert('Configure su URL de PayPal en el panel de administraci√≥n');
            }
        }

        function showAdminPanel() {
            const password = prompt("üîê Ingresa el c√≥digo de acceso admin:");
            if (password === "alicia12345") {
                showAdminModal();
                loadMoviesTable();
            }
        }

        function showAdminModal() {
            const modal = document.getElementById('admin-modal');
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeAdminModal() {
            const modal = document.getElementById('admin-modal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function switchAdminTab(tabName) {
            document.querySelectorAll('.admin-tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(`tab-${tabName}`).classList.add('active');
            document.querySelector(`.admin-tab:nth-child(${['peliculas', 'config', 'donaciones'].indexOf(tabName) + 1})`).classList.add('active');
        }

        function saveConfigSettings() {
            config.adEnabled = document.getElementById('admin-ads').value === 'true';
            config.adDuration = parseInt(document.getElementById('ad-duration').value);
            saveConfig();
            alert('‚úÖ Configuraci√≥n guardada');
        }

        function saveDonationSettings() {
            config.paypalUrl = document.getElementById('admin-paypal').value;
            saveConfig();
            alert('‚úÖ URL de PayPal guardada');
        }

        function scrollToMovies() {
            document.getElementById('categories').scrollIntoView({ behavior: 'smooth' });
        }

        function showInfo() {
            alert('VERTIFLIX - Plataforma de streaming gratuita\n\nDisfruta de pel√≠culas y series sin costo alguno.');
        }

        function searchMovies() {
            const searchTerm = document.getElementById('search-input').value.trim();
            if (searchTerm) {
                const filteredMovies = allMovies.filter(movie => 
                    movie.titulo.toLowerCase().includes(searchTerm.toLowerCase())
                );
                displayMovies(filteredMovies);
            }
        }

        // Cerrar modales con ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeMovieModal();
                closeVideoModal();
                closeAdminModal();
            }
        });
    </script>
</body>
</html>
